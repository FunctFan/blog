---
layout: post
title: "mongodb初步学习"
categories: 数据库技术
tags: [存储过程,删除字段,删除索引,mysql]
status: publish
type: post
published: true
author: blackfox
permalink: /20160811/mongodb.html
description: 'ubuntu 安装 flashplayer'
---

MongoDB 是由C++语言编写的，是一个基于分布式文件存储的开源数据库系统。
在高负载的情况下，添加更多的节点，可以保证服务器性能。
MongoDB 旨在为WEB应用提供可扩展的高性能数据存储解决方案。

安装
===
mongodb 安装很简单，不管windows还是linux直接去官方下载压缩包解压就行了。本人使用的linux

```bash
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-amazon-3.2.8.tgz
tar xvpzf mongodb-linux-x86_64-amazon-3.2.8.tgz
mv mongodb-linux-x86_64-ubuntu1204-3.0.3 /usr/local/mongodb
```

添加配置文档
=====

```bash
vim /usr/local/mongodb/mongodb.conf
```
添加配置 <code>dbpath=/data/mongodb</code>
创建软连接,并创建目录，<code>{mongo_dir}</code> 表示mongodb的安装目录

```bash
cd /usr/local/bin
ln -s {mongo_dir}/bin/mongod
ln -s {mongo_dir}/bin/mongo

mkdir -p /data/mongodb
```

启动
===
启动很简单

```bash
mongod -f /usr/local/mongodb/mongodb.conf
```
启动成功之后，用<code>mongo</code>客户端连接服务器

用户管理
===
mongodb创建用户老版本和新版不同，新版屏蔽了<code>addUser</code>方法

```bash
use admin

db.addUser("root", "123456", false); #老版本数据库

db.createUser({user: "root",pwd: "123456",roles: [{ role: "root", db: "admin" }]}); #新版数据库

db.system.users.find().pretty(); #查询用户

db.removeUser("root"); #删除用户

```
<code>addUser</code>方法的三个参数分别是用户名，密码，第三个参数是表示是否是只读用户，默认是false

<code>createUser</code>是新版的创建用户的方法

> user : 用户名 <br>
pwd : 密码 <br>
roles : 指定用户的角色，可以用一个空数组给新用户设定空角色；在roles字段,可以指定内置角色和用户定义的角色

<strong>角色可选值如下</strong>

* Read：允许用户读取指定数据库
* readWrite：允许用户读写指定数据库
* dbAdmin：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile
* userAdmin：允许用户向system.users集合写入，可以找指定数据库里创建、删除和管理用户
* clusterAdmin：只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。
* readAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读权限
* readWriteAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读写权限
* userAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的userAdmin权限
* dbAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。
* root：只在admin数据库中可用。超级账号，超级权限

添加文档
===
mongodb不需要单独创建数据库和数据表(mongo中叫集合)，很方便，由于时nosql，数据的格式也是很灵活，是一个json对象

```bash
use user;   #切换数据库，如果不存在则创建

> show tables;
system.indexes
system.users
system.version
> db.blog.insert({id:1, title:"this is a test", hits:1}); #往blog数据表中插入一个文档，如果blog表不存在则自动创建
WriteResult({ "nInserted" : 1 })
```

更新文档
====
MongoDB 使用 update() 和 save() 方法来更新集合中的文档。

> update(query, data, upsert, multi);

<strong>参数说明：</strong>

* query : update的查询条件，类似sql update查询内where后面的。
* data : 要更新的数据
* upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。
* multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。

```bash
db.blog.update({id:1}, {id:2, title:"new title", hits:2}, false, true); //文档替换
db.blog.update({id:1}, {$set : {id:2, title:"new title"}, false, true); //使用修改器修改
```

mongo 有很多修改器的，下面列举几个

* $inc 增加某个字段的值  {$inc : {hits:10}} 把点击率加10
* $set 修改或者新增部分字段，而不是整个文档替换，这个用的比较经常，毕竟一般我们只改某个文档的部分内容，很少有整个替换的。
* $push 修改数组的值

```bash
> db.blog.insert({id:2, title:"new blog", tags:["fuck", "shit"]});
WriteResult({ "nInserted" : 1 })
> db.blog.find({id:2});
{ "_id" : ObjectId("57ac4b860776d82c21a31d77"), "id" : 2, "title" : "new blog", "tags" : [ "fuck", "shit" ] }
> db.blog.update({id:2}, {$push : {tags:"oh mygod"}});
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.blog.find({id:2});
{ "_id" : ObjectId("57ac4b860776d82c21a31d77"), "id" : 2, "title" : "new blog", "tags" : [ "fuck", "shit", "oh mygod" ] }
```

查询文档
====
mongo的查询功能很强大，几乎可以跟sql数据库相媲美，尤其是还提供了很多操作符查询的
"$gt" 、"$gte"、 "$lt"、 "$lte"、"null查询"、"$all"、"$size"、"$in"、"$nin"、
"$and"、"$nor"、"$not"、"$or"、"$exists"、"$mod"、"$regex"、"$where"、"$slice"、"$elemMatch"...

下面举几个例子

```bash
db.blog.find();  #查找所有文档
db.blog.find({id:1}); #查找id=1的文档
db.user.find({name:/jack/i}); #正则查询，相当于sql中like查询
db.user.find({age:{$gte: 16, $lt:18}}); #where age > 16 AND age < 18
db.user.find({$or:{name:"xiaoming", sex:"M"}}); #where name=xiaoyang OR sex=M
db.user.find({name : {$in:["xiaoming","xiaoyang", "xiaowang"]}}); #where name IN('xiaoming', 'xiaoyang', 'xiaowang')
...
```

删除文档
====
> db.remove(query, justOne);

<strong>参数说明：</strong>

* query : update的查询条件，类似sql update查询内where后面的。
* justOne : 默认为true，之删除匹配到的第一文档，如果设置为true，则会删除匹配到的所有文档

```bash
db.blog.remove({id:1});
db.user.remove({status:0}, false); #删除所有未审核的用户
```




